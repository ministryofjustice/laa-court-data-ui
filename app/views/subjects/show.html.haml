- content_for :pre_heading do
  = render '/feedback_on_appeals_to_crown_court', application: @application

- content_for :custom_packs do
  = javascript_include_tag 'unlink', defer: true
= govuk_page_heading(@subject.name,
                     caption_text: @application.appeal? ? t(".appellant") : t(".respondent"),
                     title: @application.appeal? ? t(".appeal_title") : t(".title"),
                     tag_options: { class: "govuk-!-margin-bottom-5" })
- if @application.appeal?
  %strong.govuk-tag{ class: "govuk-tag--purple govuk-!-margin-bottom-5" }
    = t("subjects.appeal")
- else
  %strong.govuk-tag{ class: "govuk-tag--yellow govuk-!-margin-bottom-5" }
    = t("subjects.#{@application.application_category}")

  .govuk-body
    = t("subjects.show.alert")

:ruby
  link_url = if @application.maat_linked?
    unlink_court_application_subject_path(@application.application_id)
  else
    link_court_application_subject_path(@application.application_id)
  end
= form_with(model: @form_model, url: link_url, data: { turbo: false }) do |f|
  - content_for :error_summary do
    = f.govuk_error_summary

  .govuk-grid-row
    .govuk-grid-column-two-thirds
      %table.govuk-table
        %caption.govuk-table__caption.govuk-visually-hidden
          = t(".respondent")
        %tbody.govuk-table__body
          %tr.govuk-table__row
            %th.govuk-table__header{ scope: "row" }
              = t(".date_of_birth")
            %td.govuk-table__cell
              = l(@subject.date_of_birth)
          %tr.govuk-table__row
            %th.govuk-table__header{ scope: "row" }
              = t(".case_urn")
            %td.govuk-table__cell
              = @application.prosecution_case_reference
          - if @application.appeal?
            %tr.govuk-table__row
              %th.govuk-table__header{ scope: "row" }
                = t(".arrest_summons_number")
              %td.govuk-table__cell
                = @subject.defendant_asn
          - else
            %tr.govuk-table__row
              %th.govuk-table__header{ scope: "row" }
                = t(".respondent_arrest_summons_number")
              %td.govuk-table__cell
                = @subject.defendant_asn
            - if @application.breach?
              %tr.govuk-table__row
                %th.govuk-table__header{ scope: "row" }
                  = t(".plea")
                %td.govuk-table__cell
                  = @application.result_string
          %tr.govuk-table__row
            %th.govuk-table__header{ scope: "row" }
              = t(".maat_number")
            %td.govuk-table__cell
              = @application.maat_reference

  = link_to t(".view.#{@application.application_category}"),
            court_application_path(@application.application_id),
            class: "govuk-button govuk-button--secondary"

  - if @application.appeal?
    %turbo-frame#offence-table{
      src: offences_defendant_path(@application.defendant.id, urn: @application.prosecution_case_reference, offence_ids: @subject.offence_summary.map(&:id).join(","))
    }
      = render partial: 'defendants/offences',
               locals: { defendant: @application.defendant, offence_history_collection: @offence_history_collection, offence_ids: @subject.offence_summary.map(&:id) }
      - if @offence_history_collection.nil?
        .moj-js-hidden{ class: "govuk-!-margin-bottom-4" }
          = link_to t('defendants.reload'), court_application_subject_path(@application.application_id, include_offence_history: 'true'), class: 'govuk-link'

  .govuk-grid-row
    .govuk-grid-column-two-thirds
      - unless FeatureFlag.enabled?(:no_linking)
        - if @application.maat_linked?
          %h2.govuk-heading-m{ class: "govuk-!-margin-bottom-2" }
            = t('defendants.unlink.detail')
          = render 'defendants/unlink_warning'
          = render 'defendants/unlinking_fields', { f: }
        - else
          = f.govuk_text_field :maat_reference,
                               label: { text: t('laa_reference.link.form.maat_reference.label') },
                               hint: { text: t('laa_reference.link.form.maat_reference.hint') }

          = f.govuk_submit t('laa_reference.link.form.submit'), data: { disable_with: 'Linking...' }
